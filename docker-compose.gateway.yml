version: '3.8'

# Supergateway 网关服务配置（替代方案）
# 如果上面的配置不工作，可以使用这个独立的网关服务

services:
  # Supergateway - 独立网关服务
  supergateway:
    image: supercorp/supergateway:latest
    container_name: geodata-supergateway
    environment:
      LOG_LEVEL: ${GATEWAY_LOG_LEVEL:-info}
    ports:
      - "${GATEWAY_SSE_PORT:-8000}:8000"
      - "${GATEWAY_WS_PORT:-8001}:8001"
    volumes:
      # 挂载项目目录，以便访问MCP服务器
      - .:/app:ro
      - ./config:/app/config:ro
      - ./specs:/app/specs:ro
    depends_on:
      - postgres
      - mcp-server
    restart: unless-stopped
    networks:
      - geodata-network
    # 方式1：直接运行Python命令（需要Python环境）
    # command:
    #   - "--stdio"
    #   - "python"
    #   - "/app/mcp_server.py"
    #   - "--port"
    #   - "8000"
    #   - "--mode"
    #   - "sse"
    
    # 方式2：通过docker exec连接到mcp-server（推荐）
    command:
      - "--stdio"
      - "sh"
      - "-c"
      - "docker exec -i geodata-mcp-server python /app/mcp_server.py"
      - "--port"
      - "8000"
      - "--mode"
      - "sse"
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

